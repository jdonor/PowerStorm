<%= javascript_include_tag "https://www.google.com/jsapi" %>
<%= stylesheet_link_tag "building_show.css" %>


<script type="text/javascript">
	var colors = ['blue', 'lawngreen', 'yellow', 'red'];
	var a = location.href.split('/');
	var abr = a[a.length - 1];
	
	google.load("visualization", "1", {packages:["corechart"]});
    google.setOnLoadCallback(draw_charts);
	
	function draw_charts() {
		draw_barchart();
		draw_daily_chart();
	}
	
	function draw_daily_chart() {
		jQuery.post('/ajax_update', {building: abr, type: "Day"}, function(data) {
		
		});
	}
	
	function draw_barchart() {
		jQuery.post('/ajax_update', {building: abr, type: "update"}, function(data) {
			var d = eval(data);
			console.log(d);
			var data = new google.visualization.DataTable();
			data.addColumn('number', 'KWh');
			data.addRows(1);
			data.setValue(0, 0, d.current);
			
			var data_range = Math.ceil(d.max);
			var quadrant = Math.ceil(data_range / 4.0);
			var bar_color = 0;
			var cc = d.current;		
			
			data.setValue(0, 0, cc);
			
			if (cc <= quadrant) {
				bar_color = colors[0];
			} else if (cc <= 2 * quadrant) {
				bar_color = colors[1];
			} else if (cc <= 3 * quadrant) {
				bar_color = colors[2];
			} else if (cc <= 4 * quadrant) {
				bar_color = colors[3];
			}
			
			var chart = new google.visualization.BarChart(document.getElementById('chart'));
			chart.draw(data, {title: 'Current Electricity Usage',
							  colors: [bar_color],		// rgb = a << 24 | r << 16 | g << 8 | b
							  hAxis: {maxValue: d.max, minValue: d.min},
							  legend: 'none',
							  /*backgroundColor: {stroke:'gray', strokeWidth:5}*/});
		});
	}

	window.onresize = function(event) {
		draw_charts();
	}
	
	function update_info() {
		setInterval(function() {
		  d();
	    }, 5 * 60000);
	}
	
	window.onload = function () {
	  var a = location.href.split('/');
	  var abr = a[a.length - 1];
	  update_info();
	  jQuery.post('/ajax_update', {building: abr, type: "load"}, function(data) {
		//console.log(data);
	  });
	}

    </script>

<div class="colmask threecol">
	<div class="colmid">
		<div class="colleft">
			<div class="col1">
				<!-- middle column -->
				<div class="content">
					<h3>Graph Part </h3>
				</div>
			</div>
			<div class="col2">
				<!-- left column -->
				<div class="content">
					<h3> Current Electricity Usage: </h3>
					</br></br></br></br></br></br>
					<p id="current_usage" class="stat_display">200</br></p>
					<p id="usage_units" class="units">kWh</p>
				</div>				
			</div>
			<div class="col3">
				<!-- right column -->
				<div class="content">
					<h3>Current Cost:</h3>
					</br></br></br></br></br></br>
					<p id="current_cost" class="stat_display">$512.20</br></p>
					<p id="cost_units" class="units">per hour</p>
				</div>
			</div>
		</div>
	</div>
<div>

<div id="chart"> <h1>Show me the chart!</h1></div>
